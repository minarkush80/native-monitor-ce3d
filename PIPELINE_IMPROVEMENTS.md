# 流水线执行改进说明

## 问题描述

原有的流水线执行机制存在以下问题：
1. 代码执行完成后，进程可能仍在输出日志，导致任务一直处于运行状态
2. 无法主动检测输出文件的生成情况
3. 缺乏超时机制，可能导致任务无限期挂起
4. 无法强制终止失控的进程

## 解决方案

### 1. 多线程并行处理
- **输出读取线程**：实时读取stdout和stderr
- **文件检查线程**：定期检查输出文件是否生成
- **进程监控线程**：监控进程状态
- **主控制线程**：协调各线程，决定任务完成条件

### 2. 智能完成检测
任务完成的条件（满足任一即可）：
- ✅ **输出文件已生成**：检测到预期的输出文件
- ✅ **进程正常结束**：进程退出码为0
- ⚠️ **执行超时**：超过配置的最大执行时间
- ❌ **检查超时**：文件检查次数达到上限

### 3. 文件检查机制
- 每10秒检查一次输出文件（可配置）
- 支持检查多种文件格式：`.jsonl`, `.json`, `.txt`
- 智能匹配相关文件名
- 最多检查30分钟（可配置）

### 4. 超时和强制终止
- 全局超时：30分钟（可配置）
- 进程强制终止：`process.destroyForcibly()`
- 线程池管理：确保所有线程正确关闭
- 资源清理：防止内存泄漏

## 配置参数

在 `application.yml` 中可配置：

```yaml
llm:
  mapreduce:
    pipeline:
      timeout-minutes: 30              # 流水线执行超时时间（分钟）
      file-check-interval-seconds: 10  # 文件检查间隔（秒）
      max-file-check-attempts: 180     # 最大文件检查次数
```

## 实时监控

### 系统日志
- `[SYSTEM]` 标记的系统状态日志
- 文件检查进度更新
- 进程终止原因记录

### 进度更新
- 0%：开始执行流水线
- 5-20%：根据日志关键词智能识别
- 50-90%：文件检查阶段
- 95%：输出文件已生成
- 100%：任务完成

## 输出文件检测

### 主要检测路径
```
{outputFile}_crawl_result.jsonl
```

### 备用检测逻辑
- 检查包含基础文件名的所有文件
- 支持 `.jsonl`, `.json`, `.txt` 扩展名
- 文件大小必须大于0

## 错误处理

### 超时处理
```
Pipeline execution issue: 执行超时. Output file not found: /path/to/file
```

### 文件未找到
```
Pipeline execution issue: 输出文件检查超时，未找到预期文件. Output file not found: /path/to/file
```

### 进程异常
```
Pipeline execution issue: 进程正常结束，退出码: 1. Output file not found: /path/to/file
```

## 优势

1. **可靠性提升**：不再依赖进程退出状态，主动检测实际输出
2. **超时保护**：防止任务无限期挂起
3. **资源管理**：正确清理线程和进程资源
4. **实时反馈**：提供详细的执行进度和状态信息
5. **可配置性**：支持根据实际需要调整超时和检查参数

## 使用建议

1. **开发环境**：可以减少超时时间以便快速测试
2. **生产环境**：保持默认30分钟超时，确保复杂任务有足够时间完成
3. **监控**：关注系统日志中的 `[SYSTEM]` 标记，了解任务执行状态